apiVersion: apps/v1
kind: Deployment
metadata:
  name: guacamole
  namespace: remote-access
spec:
  replicas: 1
  selector:
    matchLabels:
      app: guacamole
  template:
    metadata:
      labels:
        app: guacamole
    spec:
      initContainers:
        - name: build-guac-mobile-ime
          image: eclipse-temurin:17-jdk-jammy
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh", "-lc", "set -e; mkdir -p /build/js; cp /src/guac-manifest.json /build/guac-manifest.json; cp /src/js/auto-ime.js /build/js/auto-ime.js; jar cf /out/guac-mobile-ime.jar -C /build .; ls -la /out"]
          volumeMounts:
            - name: guac-mobile-ime-src
              mountPath: /src
            - name: guac-extensions
              mountPath: /out
      containers:
        - name: guacamole
          image: guacamole/guacamole:1.5.5
          imagePullPolicy: IfNotPresent
          env:
            - name: GUACD_HOSTNAME
              value: guacd
            - name: GUACD_PORT
              value: "4822"
            - name: POSTGRES_HOSTNAME
              value: guac-postgres
            - name: POSTGRES_PORT
              value: "5432"
            - name: POSTGRES_DATABASE
              valueFrom:
                secretKeyRef:
                  name: guac-db-secrets
                  key: POSTGRES_DB
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: guac-db-secrets
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: guac-db-secrets
                  key: POSTGRES_PASSWORD
          ports:
            - name: http
              containerPort: 8080
          volumeMounts:
            - name: guac-extensions
              mountPath: /etc/guacamole/extensions
      volumes:
        - name: guac-extensions
          emptyDir: {}
        - name: guac-mobile-ime-src
          configMap:
            name: guac-mobile-ime
            items:
              - key: guac-manifest.json
                path: guac-manifest.json
              - key: auto-ime.js
                path: js/auto-ime.js
---
apiVersion: v1
kind: Service
metadata:
  name: guacamole
  namespace: remote-access
spec:
  type: ClusterIP
  selector:
    app: guacamole
  ports:
    - name: http
      port: 8080
      targetPort: http

