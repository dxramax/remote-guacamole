apiVersion: batch/v1
kind: Job
metadata:
  name: set-rdp-credentials
  namespace: remote-access
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: set-creds
          image: postgres:15-alpine
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: guac-db-secrets
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: guac-db-secrets
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: guac-db-secrets
                  key: POSTGRES_DB
            # Update these values with your Windows credentials
            - name: RDP_USERNAME
              value: "Atheeb\\a.alakkad"
            - name: RDP_PASSWORD
              value: "RAfin@2026"
            - name: CONNECTION_NAME
              value: "Windows-Workstation"
          command:
            - /bin/sh
            - -lc
            - |
              set -euo pipefail
              export PGPASSWORD="$POSTGRES_PASSWORD"
              until pg_isready -h guac-postgres -U "$POSTGRES_USER" >/dev/null 2>&1; do
                echo "Waiting for Postgres..."; sleep 3;
              done

              echo "Setting RDP credentials for connection: $CONNECTION_NAME"

              # Delete existing username and password parameters
              psql -h guac-postgres -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "
                DELETE FROM guacamole_connection_parameter
                WHERE connection_id = (SELECT connection_id FROM guacamole_connection WHERE connection_name='$CONNECTION_NAME')
                  AND parameter_name IN ('username', 'password');
              "

              # Insert username and password
              psql -h guac-postgres -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "
                INSERT INTO guacamole_connection_parameter (connection_id, parameter_name, parameter_value)
                SELECT connection_id, 'username', '$RDP_USERNAME'
                FROM guacamole_connection
                WHERE connection_name = '$CONNECTION_NAME';
              "

              psql -h guac-postgres -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "
                INSERT INTO guacamole_connection_parameter (connection_id, parameter_name, parameter_value)
                SELECT connection_id, 'password', '$RDP_PASSWORD'
                FROM guacamole_connection
                WHERE connection_name = '$CONNECTION_NAME';
              "

              echo "âœ“ RDP credentials set successfully"
              echo ""
              echo "Connection parameters:"
              psql -h guac-postgres -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "
                SELECT parameter_name,
                       CASE
                         WHEN parameter_name = 'password' THEN '********'
                         ELSE parameter_value
                       END as parameter_value
                FROM guacamole_connection_parameter
                WHERE connection_id = (SELECT connection_id FROM guacamole_connection WHERE connection_name='$CONNECTION_NAME')
                ORDER BY parameter_name;
              "
